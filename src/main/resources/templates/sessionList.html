<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="/fragments/head :: head('Study Time :: Session List')">
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container-md  rounded shadow
        my-3 background-img">

    <div th:replace="/fragments/container_header_and_footer :: row_header"></div>
    <form method="get" th:action="@{/sessionList/1}">
        <div class="input-group mb-3 search-bar">
            <input name="sortField" th:value="${sortField}" type="hidden">
            <input name="sortDir" th:value="${sortDir}" type="hidden">

            <input aria-describedby="button-addon2" aria-label="Search word" class="form-control"
                   name="keyword"
                   th:placeholder="${!#strings.isEmpty(keyword) ? keyword : ''}" type="text">
            <button class="btn btn-outline-secondary" id="button-addon2" type="submit">Search</button>
            <button class="btn btn-outline-secondary" id="clearKeyword" type="button">Clear</button>
        </div>
    </form>

    <div class="row">
        <div class="col-md">
            <!--                <div class="container">
                                <table class="table table-striped table-hover table-sm session-table">
                                    <thead class="thead-dark session-table">
                                    <tr>
                                        <th scope="col" th:replace="/fragments/table_headers :: column_link('date', 'Date')"></th>
                                        <th scope="col">Content</th>
                                        <th scope="col">Feelings</th>
                                        <th scope="col" class="session-table-duration">Duration</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="studySession : ${sessionList}" class="session-table text-size-and-font">
                                        <td class="session-table-date" th:text="${studySession.date}" ></td>
                                        <td id="table_row_content" th:text="${studySession.content}" th:onclick="|returnMarkdownFromOneSession('${studySession.id}')|"></td>
                                        <td th:text="${studySession.feelings}" th:onclick="|returnMarkdownFromOneSession('${studySession.id}')|"></td>
                                        <td class="session-table-duration" th:onclick="|returnMarkdownFromOneSession('${studySession.id}')|">duration</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>-->

            <div class="container d-inline-flex flex-wrap justify-content-center">
                <div class="personal-card card col-md-3 text-white bg-dark mb-3 mx-2"
                     th:onclick="|returnMarkdownFromOneSession('${studySession.id}')|"
                     th:each="studySession : ${sessionList}">
                    <div class="card-header">[[${studySession.date}]]</div>
                    <div class="card-body d-flex flex-column align-items-start">
                        <h5 class="card-title ">Content</h5>
                        <p id="cardContentParagraph" class="card-text personal-card-content ">[[${studySession.content}]]</p>
                    </div>
                    <div class="card-footer">
                        <small class="text-muted">duration</small>
                    </div>
                </div>
            </div>


            <!--Hidden Fields and Data Storage-->
            <div th:replace="/fragments/emptyTextArea :: emptyTextArea"></div>
            <!--<textarea class="form-control" id="textarea-hidden-sessionList" rows="12" cols="100" hidden></textarea>-->

            <div class="container text-center my-5" th:if="${totalPages == 0}">
                <p class="pagination-text-size">No results found for: [[${keyword}]]</p>
            </div>
            <div class="container text-center" th:if="${totalPages > 0}">
                <p class="pagination-text-size">Page [[${pageNum}]] of [[${totalPages}]]</p>
            </div>
            <div class="container mt-2" th:if="${totalPages > 1}">
                <nav aria-label="Page navigation example">
                    <ul class="pagination justify-content-center">
                        <li class="page-item"><a
                                class="page-link"
                                th:classappend="${currentPage == 1 ? 'disabled' : ''}"
                                th:href="@{'/sessionList/1' + '?sortField=' + ${sortField} + '&sortDir=' + ${sortDir}
                                        + ${!#strings.isEmpty(keyword) ? '&keyword=' + keyword : '' }}">First</a></li>
                        <li class="page-item">
                            <a
                                    aria-label="Previous"
                                    class="page-link"
                                    th:classappend="${currentPage == 1 ? 'disabled' : ''}"
                                    th:href="@{'/sessionList/' + ${currentPage - 1} + '?sortField=' + ${sortField} + '&sortDir=' + ${sortDir}
                                            + ${!#strings.isEmpty(keyword) ? '&keyword=' + keyword : '' }}">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>

                        <!--TODO: refactor-->
                        <li class="page-item"
                            th:classappend="${currentPage == i ? 'active' : ''}"
                            th:each="i : ${#numbers.sequence(currentPage - 2, currentPage + 2)}"
                            th:if="${currentPage > 5 && currentPage <= totalPages - 2}">
                            <a class="page-link" th:href="@{'/sessionList/' + ${i} + '?sortField=' + ${sortField} + '&sortDir=' + ${sortDir}
                                    + ${!#strings.isEmpty(keyword) ? '&keyword=' + keyword : '' }}">[[${i}]]</a>
                        </li>

                        <li class="page-item"
                            th:classappend="${currentPage == i ? 'active' : ''}"
                            th:each="i : ${#numbers.sequence(1, (totalPages < 5 ? totalPages : 5))}"
                            th:if="${currentPage <= 5}">
                            <a class="page-link" th:href="@{'/sessionList/' + ${i} + '?sortField=' + ${sortField} + '&sortDir=' + ${sortDir}
                                    + ${!#strings.isEmpty(keyword) ? '&keyword=' + keyword : '' }}">[[${i}]]</a>
                        </li>

                        <li class="page-item"
                            th:classappend="${currentPage == i ? 'active' : ''}"
                            th:each="i : ${#numbers.sequence(totalPages - 4, totalPages)}"
                            th:if="${(currentPage > totalPages - 2) && currentPage > 5}">
                            <a class="page-link"
                               th:href="@{'/sessionList/' + ${i} + '?sortField=' + ${sortField} + '&sortDir=' + ${sortDir}}">[[${i}]]</a>
                        </li>

                        <li class="page-item">
                            <a
                                    aria-label="Next"
                                    class="page-link" th:classappend="${currentPage == totalPages ? 'disabled' : ''}"
                                    th:href="@{'/sessionList/' + ${currentPage + 1} + '?sortField=' + ${sortField} + '&sortDir=' + ${sortDir}
                                            + ${!#strings.isEmpty(keyword) ? '&keyword=' + keyword : '' }}">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item"><a
                                class="page-link"
                                th:classappend="${currentPage == totalPages ? 'disabled' : ''}" th:href="@{'/sessionList/' + ${totalPages} + '?sortField=' + ${sortField} + '&sortDir=' + ${sortDir}
                                         + ${!#strings.isEmpty(keyword) ? '&keyword=' + keyword : '' }}">Last</a></li>
                    </ul>
                </nav>
            </div>

        </div>
    </div>

    <div th:replace="/fragments/container_header_and_footer :: row_footer"></div>
</div>

<!-- Modal Indentation Warning -->
<div th:replace="/fragments/modal :: modal_indentation_warning"></div>
<!-- Modal Preview -->
<div th:replace="/fragments/modal :: modal_preview"></div>
<!-- Modal Editing -->
<div th:replace="/fragments/modal :: modal_edit"></div>

<script src="/js/EventListener_sessionList.js"></script>

<!--Necessary for jQuery-->
<script crossorigin="anonymous"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>

<!--TO DO refactor this code into a JS file-->
<script th:inline="javascript">

    // Get back to SessionForm.html from SessionList.html
    document.getElementById("returnToSessionFormBtn").addEventListener("click", function () {
        window.location.href = "/";
    });

    // Clear search form by making a new call to /sessionList
    document.getElementById("clearKeyword").addEventListener("click", function () {
        window.location.href = "/sessionList/1?sortField=date&sortDir=dsc";
    });

    let cardContentParagraph = document.getElementById("cardContentParagraph").innerText;
    const keyword = [[${keyword}]];
    if (cardContentParagraph != null && keyword != null) {
        window.addEventListener("load", iterateOverAllP);
    }

    // Iterate over all <p>
    function iterateOverAllP() {
        const cells = document.querySelectorAll('p');
        cells.forEach(function (cell) {
            cell.innerHTML = highLightKeyWord(cell.innerText, keyword);
        })
    }

    // Highlight text in the <td> if equal to the keyword
    function highLightKeyWord(rowValue, keyword) {
        let replacement = "<span style=\"background-color:#f0ad4e\n;font-weight: bold;\">"
            + keyword
            + "</span>";

        /*return rowValue.replaceAll(keyword, replacement);*/

        let regex = new RegExp(keyword, 'gi');
        return rowValue.replaceAll(regex, replacement);
    }

    // Preview in Modal
    function returnMarkdownFromOneSession(id) {
        idFecthedByGetSessionMarkdown = id;
        let hiddenTextAreaSessionList = document.getElementById("textarea-hidden");

        fetch("/getSessionMarkdown/" + id)
            .then(response => response.text())
            .then(data => {
                hiddenTextAreaSessionList.value = data;

                const markdownDivSessionList = document.getElementById("markdownPreview");
                markdownDivSessionList.innerHTML = "";

                const previewModal = new bootstrap.Modal(document.getElementById("previewModal"), {});

                const valueToAdd = "<md-block>" + hiddenTextAreaSessionList.value + "</md-block>";

                const markdownDiv = document.getElementById("markdownPreview");

                markdownDiv.insertAdjacentHTML("beforeend", valueToAdd);
                previewModal.show();

            });


    }

    function returnSessionToEdit() {
        const id = idFecthedByGetSessionMarkdown;
        const form = document.getElementById("formEdit");
        const divPauseTime = document.getElementById("formEdit_pauseTime");
        const divResumeTime = document.getElementById("formEdit_resumeTime");
        const modalEditFormsH2 = document.getElementById("modalEditFormsH2");
        const formInputContent = document.getElementById("formInputContent");
        const formInputFeelings = document.getElementById("formInputFeelings");

        fetch("/getSessionToEdit/" + id)
            .then(response => response.json())
            .then(data => {
                const jsonFile = data;

                if (jsonFile.pauseTime === null) {
                    divPauseTime.hidden = true;
                    divResumeTime.hidden = true;
                }

                modalEditFormsH2.innerText = jsonFile.date;

                $.each(jsonFile, function (key, value) {
                    if (form.elements[key] != null) {
                        form.elements[key].value = value;
                    }
                });

                /* revert value of textarea */
                formInputContent.value = revertIndentation("formInputContent");
                formInputFeelings.value = revertIndentation("formInputFeelings");

            })


    }


</script>

</body>
</html>